<html>
<head>
  <script src="../public/app/grid_imager.js" type="text/javascript"></script>
  <script src="harness.js" type="text/javascript"></script>
  <script type="text/javascript">
    debug = x => { console.log(x); };
    const cssFilePath = 'grid_imager_test_style.css';

    beforeSuite = () => {
      const css = document.createElement('link');
      css.type = 'text/css';
      css.rel = 'stylesheet';
      css.href = cssFilePath;
      const head = document.getElementsByTagName('head')[0];
      head.appendChild(css);
    }

    beforeTest = complete => {
      gi = new GridImager();
      gi.addCssFile(cssFilePath, () => {
        gi.recalculateStyleString();
        complete();
      });
    };

    function createSimpleDom() {
      const square = document.createElement('div');
      square.classList.add('square');
      const circle = document.createElement('div');
      circle.classList.add('circle');
      square.appendChild(circle);
      document.body.appendChild(square);
      return square;
    }

    function createDomWithInlineSvgBackgroundImage() {
      const square = document.createElement('div');
      square.classList.add('square');
      const divWithInlineSvgBackgroundImage = document.createElement('div');
      divWithInlineSvgBackgroundImage.classList.add('inline-svg-background');
      square.appendChild(divWithInlineSvgBackgroundImage);
      document.body.appendChild(square);
      return square;
    }

    function createDomWithExternalSvgBackgroundImage() {
      const square = document.createElement('div');
      square.classList.add('square');
      const divWithExternalSvgBackgroundImage = document.createElement('div');
      divWithExternalSvgBackgroundImage.classList.add(
          'external-svg-background');
      square.appendChild(divWithExternalSvgBackgroundImage);
      document.body.appendChild(square);
      return square;
    }

    addTest('Can save simple dom to svg dataurl', async () => {
      const input = createSimpleDom();

      const svgDataUrl = await gi.node2svgDataUrl(input, 200, 20);

      assert(svgDataUrl.includes('%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20class%3D%22square%22%3E%3Cdiv%20class%3D%22circle%22%3E%3C%2Fdiv%3E%3C%2Fdiv%3E%3C%2FforeignObject%3E</svg>'));
      assert(svgDataUrl.startsWith('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="20">%3CforeignObject%20style%3D%22width%3A100%25%3Bheight%3A100%25%22%3E%3Cstyle%3E%3C!--%20grid_imager_test_style.css%20--%3E'));

      const img = document.createElement('img');
      img.src = svgDataUrl;
      document.body.appendChild(img);
      testCompleted();
    });

    addTest('Can save simple dom to svg element', async () => {
      const input = createSimpleDom();

      const svgElement = await gi.node2svgElement(input);

      const expectedInnerHtml = '<foreignobject style="width:100%;height:100%"><div xmlns="http://www.w3.org/1999/xhtml" class="square"><div class="circle"></div></div></foreignobject>';
      assert(svgElement.innerHTML == expectedInnerHtml);

      document.body.appendChild(svgElement);
      testCompleted();
    })

    addTest('Can save simple dom to png dataurl', async () => {
      const input = createSimpleDom();

      const pngDataUrl = await gi.node2pngDataUrl(input, 200, 20);

      const expectedDataUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAAAUCAYAAADIpHLKAAADWUlEQVRoQ+2b20ocQRCGvyVqjGISFfEYDxByFbxQCMYDvkCCwVfwJpA8TgK58RUkkjxAxEMkoBeSKxE8RyWoUdF4Chuqd3vsjGvGdXddZrYaiu7e6a7p+qdqZrbnr1gc4hRA2aGKfe57ckQZJ9w1ckqJ17a/ubX/uNuX9jlF/OGOkava/mNuX9aSqpRxZLQWcZ7UnjiL2w86VsJp0soT3LZYLv1yDo3OBBKXxc6RtVygt08VOwXgNRALQ4DsUskvHhrZ48E/belbscelb4NB2lc5YEFc4RwaKUEj6EvguLVcqYursmeunPTdWtqV7OZwddlRnbcAWaKVHzQYWafRqzepY5tqLwjE6bVEF4HEbS8h1WxTz4bxikbWk96RaLewnBcQchIg4vQSAGs0scojVmg2tZUtavNirJ403AjUsmW8qJkVx5tWaWKNNhZNcGW73DhA5nmClQUes2iW2MYyLRxTmu11qj5FIBCBUo5pZcl4otSPWXC8dD5wfqoB1wqQGToZp49Jepij3QSGFkUgbAjILb2dOXqZoI9xOpgNNOFSgMjd/yvPTUCISPuQ8kBFOkARCBsCsrnQzVTS08d5xjezk+cWL0DkyfCRV4wywCwdYbNV16sIZIyAPFEGGGWQEZ7y3eiLrdEQf80HPvMy4xOoAkUgKgi84BPDDBHr50t8jP6o2KV2KAJZQ6CfMQ2QrKGpiiKHgAmQLWriQwzrK1bkLq8alAkC3iuWpZpM0Ms73jLCIGcUZ6Jb5yoCoUSgmDPzB/0N783OlvmT7udiHVBhtnanzAZYN9N0Ib9pUQSihoDQW7qYTnr6lNnmreAg9Tbv/4yXbV/5JiJPGf1QGDU3KRx77IfCHibNE6KTmUDjr/UlPZUWP9VEuFdCNZFaqSaBuOuAHCAgVBMhNSZIT4u3RzVJ15YN6s0S/SRFS1z8SU26KnW8IoAlK1raqyUtCllRuFfCAs52ufETJNOFCKnR0txdyrsEl9LdM0U3PPP9dPc6Nj2qu0t5lwDIR8lbgKRjbKqEKZs4lSphSpKlbNKUJkylg3R6Y92EKZs05SZG+ZOmNGEqPXxvdbSk3LqZhr+5F5hmKwmuQtQMSrlNlbpr50idq4xGcVCbEntVam0mKbfu3EJNuf0LK72z+p0kxWUAAAAASUVORK5CYII=';
      assert(pngDataUrl == expectedDataUrl);

      const img = document.createElement('img');
      img.src = pngDataUrl;
      document.body.appendChild(img);
      testCompleted();
    });

    addTest('Can save dom with inlined svg background to png dataurl',
        async () => {
      const input = createDomWithInlineSvgBackgroundImage();

      const pngDataUrl = await gi.node2pngDataUrl(input, 200, 20);

      const expectedDataUrl = 'x';
      assert(pngDataUrl == expectedDataUrl);

      const img = document.createElement('img');
      img.src = pngDataUrl;
      document.body.appendChild(img);
      testCompleted();
    });

    addTest('Can save dom with external background to png dataurl',
        async () => {
      const input = createDomWithExternalSvgBackgroundImage();

      const pngDataUrl = await gi.node2pngDataUrl(input, 200, 20);

      const expectedDataUrl = 'x';
      assert(pngDataUrl == expectedDataUrl);

      const img = document.createElement('img');
      img.src = pngDataUrl;
      document.body.appendChild(img);
      testCompleted();
    });
  </script>
</head>
  <body>
  </body>
</html>
